<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webcam Stream —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º</title>
    <style>
        body {
            text-align: center;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .controls {
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .btn-start {
            background-color: #28a745;
            color: white;
        }
        
        .btn-start:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        
        .btn-stop {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-stop:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #6c757d;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.active {
            background-color: #28a745;
        }
        
        .status-indicator.inactive {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        
        .video-container {
            display: inline-block;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }
        
        img {
            width: 100%;
            height: auto;
            display: block;
            max-width: 90vw;
            max-height: 70vh;
        }
        
        .status-panel {
            margin-top: 20px;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 8px;
            color: #333;
            font-size: 1.1em;
            text-align: left;
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .footer {
            margin-top: 30px;
            color: #666;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• Webcam Stream —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º</h1>
        
        <div class="controls">
            <button class="btn btn-start" id="start-btn" onclick="startStream()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
            <button class="btn btn-stop" id="stop-btn" onclick="stopStream()" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        </div>
        
        <div class="status-panel">
            <div class="status-row">
                <span>–°—Ç–∞—Ç—É—Å —Å—Ç—Ä–∏–º–∞:</span>
                <span id="stream-status">
                    <span class="status-indicator inactive"></span>
                    <strong>–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</strong>
                </span>
            </div>
            <div class="status-row">
                <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–¥—Ä–æ–≤:</span>
                <span id="frame-count">0</span>
            </div>
            <div class="status-row">
                <span>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:</span>
                <span id="connection-status">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
            </div>
        </div>
        
        <div class="video-container">
            <img src="" alt="Video Stream" id="video-stream" style="display: none;">
        </div>
        
        <div class="footer">
            <p>–°–µ—Ä–≤–µ—Ä: http://localhost:5000</p>
            <p>–ü–æ—Ç–æ–∫: http://localhost:5000/video_feed</p>
        </div>
    </div>

    <script>
        let streamActive = false;
        let frameCount = 0;
        let connectionAttempts = 0;
        const maxAttempts = 5;
        const videoImg = document.getElementById('video-stream');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const streamStatus = document.getElementById('stream-status');
        const frameCountDisplay = document.getElementById('frame-count');
        const connectionStatus = document.getElementById('connection-status');

        function updateUI() {
            if (streamActive) {
                startBtn.disabled = true;
                stopBtn.disabled = false;
                streamStatus.innerHTML = '<span class="status-indicator active"></span><strong>–ê–∫—Ç–∏–≤–µ–Ω</strong>';
                videoImg.style.display = 'block';
            } else {
                startBtn.disabled = false;
                stopBtn.disabled = true;
                streamStatus.innerHTML = '<span class="status-indicator inactive"></span><strong>–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</strong>';
                videoImg.style.display = 'none';
                connectionStatus.textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
            }
        }

        async function startStream() {
            console.log('–ó–∞–ø—É—Å–∫ —Å—Ç—Ä–∏–º–∞...');
            try {
                const response = await fetch('/api/stream/start', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.status === 'started' || result.status === 'already_running') {
                    streamActive = true;
                    frameCount = 0;
                    connectionAttempts = 0;
                    updateUI();
                    
                    // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤–∏–¥–µ–æ
                    videoImg.src = '/video_feed?' + Date.now();
                    connectionStatus.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    console.log('–°—Ç—Ä–∏–º —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω');
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å—Ç—Ä–∏–º–∞: ' + result.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ API:', error);
                alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }

        async function stopStream() {
            console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç—Ä–∏–º–∞...');
            try {
                const response = await fetch('/api/stream/stop', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.status === 'stopped' || result.status === 'already_stopped') {
                    streamActive = false;
                    updateUI();
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤–∏–¥–µ–æ
                    videoImg.src = '';
                    connectionStatus.textContent = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                    console.log('–°—Ç—Ä–∏–º —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç—Ä–∏–º–∞: ' + result.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ API:', error);
                alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }

        videoImg.onload = function() {
            if (streamActive) {
                connectionStatus.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                frameCount++;
                frameCountDisplay.textContent = frameCount;
            }
        };

        videoImg.onerror = function() {
            if (streamActive) {
                connectionAttempts++;
                console.log('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –ø–æ–ø—ã—Ç–∫–∞:', connectionAttempts);
                
                if (connectionAttempts < maxAttempts) {
                    setTimeout(() => {
                        videoImg.src = '/video_feed?' + Date.now();
                    }, 1000);
                } else {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –≤–∏–¥–µ–æ –ø–æ—Ç–æ–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä.');
                    stopStream();
                }
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        updateUI();
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        setInterval(async function() {
            try {
                const response = await fetch('/api/stream/status');
                const status = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–∞–¥—Ä–æ–≤
                frameCountDisplay.textContent = status.frame_count;
                
                // –ï—Å–ª–∏ —Å—Ç—Ä–∏–º –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –Ω–æ –∞–∫—Ç–∏–≤–µ–Ω –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
                if (!status.stream_active && streamActive) {
                    streamActive = false;
                    updateUI();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
            }
        }, 2000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
    </script>
</body>
</html>
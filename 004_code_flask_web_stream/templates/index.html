{% extends "base.html" %}

{% block title %}Управление веб-камерой{% endblock %}

{% block content %}
<div class="main-layout">
    <!-- Левая панель управления (25%) -->
    <div class="control-panel">
        {% include 'components/camera_list.html' %}
        
        <div class="control-section">
            <h3><i class="fas fa-sliders-h"></i> Управление</h3>
            <div class="control-buttons">
                <button class="btn btn-start" id="start-btn" onclick="startStream()">
                    <i class="fas fa-play"></i> Запустить
                </button>
                <button class="btn btn-stop" id="stop-btn" onclick="stopStream()" disabled>
                    <i class="fas fa-stop"></i> Остановить
                </button>
                <button class="btn btn-secondary" onclick="restartStream()">
                    <i class="fas fa-redo"></i> Перезапустить
                </button>
            </div>
        </div>
        
        <div class="status-section">
            <h3><i class="fas fa-chart-line"></i> Статус</h3>
            <div class="status-grid">
                <div class="status-item">
                    <span>Стрим:</span>
                    <span id="stream-status" class="status-value">
                        <span class="status-indicator inactive"></span>
                        Остановлен
                    </span>
                </div>
                <div class="status-item">
                    <span>Кадров:</span>
                    <span id="frame-count" class="status-value">0</span>
                </div>
                <div class="status-item">
                    <span>Камера:</span>
                    <span id="camera-status" class="status-value">
                        <span class="status-indicator inactive"></span>
                        Проверка...
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Правая панель видео (75%) -->
    <div class="video-panel">
        <div class="video-container">
            <img src="{{ url_for('video_feed') }}" 
                 alt="Video Stream" 
                 id="video-stream"
                 onload="onVideoLoad()"
                 onerror="onVideoError()">
            <div id="video-placeholder" class="video-placeholder">
                <i class="fas fa-video-slash"></i>
                <p>Видеопоток неактивен</p>
            </div>
        </div>
    </div>
</div>

{% include 'components/camera_modal.html' %}

<script>
// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Обновление статуса каждые 3 секунды
    setInterval(() => {
        fetch('/api/stream/status')
            .then(r => r.json())
            .then(data => {
                updateStreamStatus(data.stream_active);
                document.getElementById('frame-count').textContent = data.frame_count;
            });
    }, 3000);
});

function onVideoLoad() {
    document.getElementById('video-placeholder').style.display = 'none';
}

function onVideoError() {
    document.getElementById('video-placeholder').style.display = 'flex';
}

function updateStreamStatus(isActive) {
    const statusEl = document.getElementById('stream-status');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    
    if (isActive) {
        statusEl.innerHTML = '<span class="status-indicator active"></span><strong>Активен</strong>';
        startBtn.disabled = true;
        stopBtn.disabled = false;
    } else {
        statusEl.innerHTML = '<span class="status-indicator inactive"></span><strong>Остановлен</strong>';
        startBtn.disabled = false;
        stopBtn.disabled = true;
    }
}
</script>

<style>
.main-layout {
    display: flex;
    height: calc(100vh - 150px);
    gap: 20px;
    padding: 20px;
}

.control-panel {
    flex: 0 0 25%;
    max-width: 350px;
    background: var(--card-bg);
    border-radius: 10px;
    padding: 20px;
    overflow-y: auto;
}

.video-panel {
    flex: 1;
    background: var(--card-bg);
    border-radius: 10px;
    padding: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.video-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

#video-stream {
    max-width: 100%;
    max-height: 100%;
    border-radius: 8px;
}

.video-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    border-radius: 8px;
}

.video-placeholder i {
    font-size: 48px;
    margin-bottom: 10px;
    opacity: 0.6;
}
</style>
{% endblock %}